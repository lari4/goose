# Goose Agent Pipelines Documentation

Этот документ описывает все возможные схемы работы (пайплайны) AI агента Goose, показывая какие промпты используются, в какой последовательности, и какие данные передаются между этапами.

---

## 1. Основной Пайплайн Взаимодействия с Пользователем (Main User Interaction Pipeline)

Это основной рабочий цикл агента при обработке запросов пользователя.

### Схема потока данных

```
┌─────────────────────────────────────────────────────────────────────┐
│                         НАЧАЛО ВЗАИМОДЕЙСТВИЯ                        │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. СБОРКА СИСТЕМНОГО ПРОМПТА (Prompt Manager)                      │
│  ─────────────────────────────────────────────────────────────────  │
│  • Выбор базового промпта:                                          │
│    - system.md (стандартный режим)                                  │
│    - system_gpt_4.1.md (расширенный режим)                          │
│  • Добавление frontend instructions:                                │
│    - desktop_prompt.md (если Desktop)                               │
│    - cli_prompt.rs (если CLI)                                       │
│  • Добавление промптов активных расширений:                         │
│    - Extension Manager, Todo, ChatRecall и т.д.                     │
│    - Memory, Tutorial, ComputerController и т.д.                    │
│  • Добавление tool_selection_strategy (если динамический выбор)     │
│  • Применение system_prompt_override (если есть)                    │
│  • Применение system_prompt_extras (если есть)                      │
│                                                                      │
│  ВЫХОД: Финальный системный промпт                                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. ПРОВЕРКА КОНТЕКСТА (Context Check)                              │
│  ─────────────────────────────────────────────────────────────────  │
│  • Проверка: достигнут ли лимит контекста?                          │
│  • Если ДА → переход к Context Summarization Pipeline (раздел 2)   │
│  • Если НЕТ → продолжение                                           │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. ПОДГОТОВКА СООБЩЕНИЙ                                            │
│  ─────────────────────────────────────────────────────────────────  │
│  • История разговора (Conversation)                                 │
│  • Текущее сообщение пользователя                                   │
│  • Метаданные видимости (agent_visible, user_visible)              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. ДИНАМИЧЕСКИЙ ВЫБОР ИНСТРУМЕНТОВ (опционально)                   │
│  ─────────────────────────────────────────────────────────────────  │
│  • Если включен dynamic tool selection:                             │
│    → переход к Tool Selection Pipeline (раздел 5)                   │
│  • Иначе: использовать все доступные инструменты                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. LLM ВЫЗОВ (Provider Complete)                                   │
│  ─────────────────────────────────────────────────────────────────  │
│  ВХОД:                                                               │
│  • system_prompt (из шага 1)                                        │
│  • conversation (из шага 3)                                         │
│  • tools (список доступных инструментов)                            │
│                                                                      │
│  ВЫХОД:                                                              │
│  • Response (сообщение ассистента)                                  │
│  • Tool requests (опционально)                                      │
│  • Provider usage (статистика)                                      │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────┴──────────┐
                    │  Tool requests?     │
                    └──────────┬──────────┘
                         ДА    │    НЕТ
                    ┌──────────┴──────────┐
                    │                     │
                    ▼                     ▼
┌─────────────────────────────────┐  ┌──────────────────────────┐
│  6a. ПРОВЕРКА РАЗРЕШЕНИЙ        │  │  6b. ВОЗВРАТ ОТВЕТА      │
│  ───────────────────────────     │  │  ───────────────────     │
│  • Анализ tool requests          │  │  • Отобразить ответ      │
│  • Определение read-only         │  │    пользователю          │
│  • Permission Pipeline (раздел 6)│  │  • Сохранить в историю   │
│  • Получение approval            │  └──────────────────────────┘
└──────────────┬──────────────────┘                │
               │                                   │
               ▼                                   │
┌─────────────────────────────────┐               │
│  7. ВЫПОЛНЕНИЕ ИНСТРУМЕНТОВ     │               │
│  ───────────────────────────     │               │
│  • Выполнение одобренных tools   │               │
│  • Сбор результатов              │               │
│  • Обработка ошибок              │               │
└──────────────┬──────────────────┘               │
               │                                   │
               ▼                                   │
┌─────────────────────────────────┐               │
│  8. РЕКУРСИВНЫЙ ВЫЗОВ LLM       │               │
│  ───────────────────────────     │               │
│  • Добавить tool results         │               │
│    к conversation                │               │
│  • Вернуться к шагу 5            │               │
│  • Повторять пока нет final      │               │
│    ответа или лимита ходов       │               │
└──────────────┬──────────────────┘               │
               │                                   │
               └───────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  9. ЗАВЕРШЕНИЕ                                                       │
│  ─────────────────────────────────────────────────────────────────  │
│  • Сохранение сессии                                                │
│  • Обновление статистики                                            │
│  • Возврат контроля пользователю                                    │
└─────────────────────────────────────────────────────────────────────┘
```

### Переменные и данные между этапами

**Шаг 1 → Шаг 5:**
- `system_prompt` (String): Полностью собранный системный промпт
- `extensions` (Vec): Список активных расширений с их инструкциями

**Шаг 3 → Шаг 5:**
- `conversation` (Conversation): История сообщений
- `messages` (Vec<Message>): Массив сообщений User/Assistant/Tool

**Шаг 5 → Шаг 6:**
- `response` (Message): Ответ LLM
- `tool_requests` (Vec<ToolRequest>): Запросы на выполнение инструментов
- `provider_usage` (ProviderUsage): Статистика использования токенов

**Шаг 6a → Шаг 7:**
- `approved_tools` (Vec<ToolRequest>): Одобренные инструменты
- `approval_status` (HashMap): Статус разрешения для каждого инструмента

**Шаг 7 → Шаг 8:**
- `tool_results` (Vec<ToolResult>): Результаты выполнения инструментов
- `errors` (Vec<Error>): Ошибки выполнения (если есть)

### Примечания

- Цикл шагов 5-8 может повторяться несколько раз (multi-turn conversation)
- На каждой итерации контекст растет (добавляются tool requests и results)
- При достижении лимита контекста запускается Context Summarization Pipeline
- При достижении max_turns взаимодействие завершается

---
