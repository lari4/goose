# Goose Agent Pipelines Documentation

Этот документ описывает все возможные схемы работы (пайплайны) AI агента Goose, показывая какие промпты используются, в какой последовательности, и какие данные передаются между этапами.

---

## 1. Основной Пайплайн Взаимодействия с Пользователем (Main User Interaction Pipeline)

Это основной рабочий цикл агента при обработке запросов пользователя.

### Схема потока данных

```
┌─────────────────────────────────────────────────────────────────────┐
│                         НАЧАЛО ВЗАИМОДЕЙСТВИЯ                        │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. СБОРКА СИСТЕМНОГО ПРОМПТА (Prompt Manager)                      │
│  ─────────────────────────────────────────────────────────────────  │
│  • Выбор базового промпта:                                          │
│    - system.md (стандартный режим)                                  │
│    - system_gpt_4.1.md (расширенный режим)                          │
│  • Добавление frontend instructions:                                │
│    - desktop_prompt.md (если Desktop)                               │
│    - cli_prompt.rs (если CLI)                                       │
│  • Добавление промптов активных расширений:                         │
│    - Extension Manager, Todo, ChatRecall и т.д.                     │
│    - Memory, Tutorial, ComputerController и т.д.                    │
│  • Добавление tool_selection_strategy (если динамический выбор)     │
│  • Применение system_prompt_override (если есть)                    │
│  • Применение system_prompt_extras (если есть)                      │
│                                                                      │
│  ВЫХОД: Финальный системный промпт                                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. ПРОВЕРКА КОНТЕКСТА (Context Check)                              │
│  ─────────────────────────────────────────────────────────────────  │
│  • Проверка: достигнут ли лимит контекста?                          │
│  • Если ДА → переход к Context Summarization Pipeline (раздел 2)   │
│  • Если НЕТ → продолжение                                           │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. ПОДГОТОВКА СООБЩЕНИЙ                                            │
│  ─────────────────────────────────────────────────────────────────  │
│  • История разговора (Conversation)                                 │
│  • Текущее сообщение пользователя                                   │
│  • Метаданные видимости (agent_visible, user_visible)              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. ДИНАМИЧЕСКИЙ ВЫБОР ИНСТРУМЕНТОВ (опционально)                   │
│  ─────────────────────────────────────────────────────────────────  │
│  • Если включен dynamic tool selection:                             │
│    → переход к Tool Selection Pipeline (раздел 5)                   │
│  • Иначе: использовать все доступные инструменты                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. LLM ВЫЗОВ (Provider Complete)                                   │
│  ─────────────────────────────────────────────────────────────────  │
│  ВХОД:                                                               │
│  • system_prompt (из шага 1)                                        │
│  • conversation (из шага 3)                                         │
│  • tools (список доступных инструментов)                            │
│                                                                      │
│  ВЫХОД:                                                              │
│  • Response (сообщение ассистента)                                  │
│  • Tool requests (опционально)                                      │
│  • Provider usage (статистика)                                      │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────┴──────────┐
                    │  Tool requests?     │
                    └──────────┬──────────┘
                         ДА    │    НЕТ
                    ┌──────────┴──────────┐
                    │                     │
                    ▼                     ▼
┌─────────────────────────────────┐  ┌──────────────────────────┐
│  6a. ПРОВЕРКА РАЗРЕШЕНИЙ        │  │  6b. ВОЗВРАТ ОТВЕТА      │
│  ───────────────────────────     │  │  ───────────────────     │
│  • Анализ tool requests          │  │  • Отобразить ответ      │
│  • Определение read-only         │  │    пользователю          │
│  • Permission Pipeline (раздел 6)│  │  • Сохранить в историю   │
│  • Получение approval            │  └──────────────────────────┘
└──────────────┬──────────────────┘                │
               │                                   │
               ▼                                   │
┌─────────────────────────────────┐               │
│  7. ВЫПОЛНЕНИЕ ИНСТРУМЕНТОВ     │               │
│  ───────────────────────────     │               │
│  • Выполнение одобренных tools   │               │
│  • Сбор результатов              │               │
│  • Обработка ошибок              │               │
└──────────────┬──────────────────┘               │
               │                                   │
               ▼                                   │
┌─────────────────────────────────┐               │
│  8. РЕКУРСИВНЫЙ ВЫЗОВ LLM       │               │
│  ───────────────────────────     │               │
│  • Добавить tool results         │               │
│    к conversation                │               │
│  • Вернуться к шагу 5            │               │
│  • Повторять пока нет final      │               │
│    ответа или лимита ходов       │               │
└──────────────┬──────────────────┘               │
               │                                   │
               └───────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  9. ЗАВЕРШЕНИЕ                                                       │
│  ─────────────────────────────────────────────────────────────────  │
│  • Сохранение сессии                                                │
│  • Обновление статистики                                            │
│  • Возврат контроля пользователю                                    │
└─────────────────────────────────────────────────────────────────────┘
```

### Переменные и данные между этапами

**Шаг 1 → Шаг 5:**
- `system_prompt` (String): Полностью собранный системный промпт
- `extensions` (Vec): Список активных расширений с их инструкциями

**Шаг 3 → Шаг 5:**
- `conversation` (Conversation): История сообщений
- `messages` (Vec<Message>): Массив сообщений User/Assistant/Tool

**Шаг 5 → Шаг 6:**
- `response` (Message): Ответ LLM
- `tool_requests` (Vec<ToolRequest>): Запросы на выполнение инструментов
- `provider_usage` (ProviderUsage): Статистика использования токенов

**Шаг 6a → Шаг 7:**
- `approved_tools` (Vec<ToolRequest>): Одобренные инструменты
- `approval_status` (HashMap): Статус разрешения для каждого инструмента

**Шаг 7 → Шаг 8:**
- `tool_results` (Vec<ToolResult>): Результаты выполнения инструментов
- `errors` (Vec<Error>): Ошибки выполнения (если есть)

### Примечания

- Цикл шагов 5-8 может повторяться несколько раз (multi-turn conversation)
- На каждой итерации контекст растет (добавляются tool requests и results)
- При достижении лимита контекста запускается Context Summarization Pipeline
- При достижении max_turns взаимодействие завершается

---

## 2. Пайплайн Суммаризации Контекста (Context Summarization Pipeline)

Автоматически срабатывает когда размер контекста приближается к лимиту модели.

### Схема потока данных

```
┌─────────────────────────────────────────────────────────────────────┐
│  ТРИГГЕР: Размер контекста >= порог                                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. ПОДГОТОВКА СООБЩЕНИЙ ДЛЯ СУММАРИЗАЦИИ                            │
│  ─────────────────────────────────────────────────────────────────  │
│  • Извлечение всех сообщений до последнего user message (если есть) │
│  • Сохранение последнего user message отдельно (опционально)        │
│                                                                      │
│  ВХОД: conversation (полная история)                                │
│  ВЫХОД: messages_to_compact (сообщения для сжатия)                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. ПОСТРОЕНИЕ ПРОМПТА ДЛЯ СУММАРИЗАЦИИ                             │
│  ─────────────────────────────────────────────────────────────────  │
│  • Загрузка: summarize_oneshot.md                                   │
│  • Рендеринг с переменными:                                         │
│    - {{messages}}: messages_to_compact в текстовом формате          │
│                                                                      │
│  ВЫХОД: system_prompt для суммаризации                              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. СОЗДАНИЕ USER ЗАПРОСА НА СУММАРИЗАЦИЮ                           │
│  ─────────────────────────────────────────────────────────────────  │
│  Message::user().with_text(                                         │
│    "Please summarize the conversation history                       │
│     provided in the system prompt."                                 │
│  )                                                                   │
│                                                                      │
│  ВЫХОД: summarization_request (массив с 1 сообщением)               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. LLM ВЫЗОВ (Fast Model)                                          │
│  ─────────────────────────────────────────────────────────────────  │
│  provider.complete_fast(                                            │
│    &system_prompt,                                                  │
│    &summarization_request,                                          │
│    &[]  // no tools                                                 │
│  )                                                                   │
│                                                                      │
│  ВЫХОД:                                                              │
│  • summary_message (Message с подробной суммаризацией)              │
│  • provider_usage (статистика)                                      │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. ОБРАБОТКА РЕЗУЛЬТАТА                                            │
│  ─────────────────────────────────────────────────────────────────  │
│  • Изменить role summary_message: User (было Assistant)            │
│  • Добавить метаданные:                                             │
│    - agent_visible = true                                           │
│    - user_visible = false                                           │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. ПОСТРОЕНИЕ НОВОГО КОНТЕКСТА                                     │
│  ─────────────────────────────────────────────────────────────────  │
│  final_messages = [                                                 │
│    // Оригинальные сообщения с измененной видимостью:               │
│    ...original_messages (agent_visible=false, user_visible=true)    │
│                                                                      │
│    // Summary message (только для агента):                          │
│    summary_message (agent_visible=true, user_visible=false)         │
│                                                                      │
│    // Instruction message (только для агента):                      │
│    Message::assistant().with_text(                                  │
│      "The previous message contains a summary...                    │
│       Do not mention that you read a summary...                     │
│       Just continue the conversation naturally..."                  │
│    ) (agent_visible=true, user_visible=false)                       │
│                                                                      │
│    // Последнее user message (если было сохранено):                 │
│    last_user_message (опционально)                                  │
│  ]                                                                   │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  7. ВОЗВРАТ В ОСНОВНОЙ ПАЙПЛАЙН                                      │
│  ─────────────────────────────────────────────────────────────────  │
│  • Замена conversation на compacted_conversation                    │
│  • Продолжение основного пайплайна с шага 5 (LLM вызов)             │
└─────────────────────────────────────────────────────────────────────┘
```

### Переменные и данные

**Вход в пайплайн:**
- `conversation` (Conversation): Полная история разговора
- `preserve_last_user_message` (bool): Сохранять ли последнее сообщение пользователя

**Между этапами:**
- `messages_to_compact` (Vec<Message>): Сообщения для сжатия
- `system_prompt` (String): Промпт из summarize_oneshot.md с {{messages}}
- `summary_message` (Message): Результат суммаризации от LLM
- `final_messages` (Vec<Message>): Новая сжатая история

**Выход из пайплайна:**
- `compacted_conversation` (Conversation): Сжатая история разговора
- `summarization_usage` (ProviderUsage): Статистика использования токенов

### Промпты, используемые на каждом этапе

1. **Шаг 2**: `summarize_oneshot.md` - основной промпт суммаризации
2. **Шаг 6**: Встроенный текст инструкции (из `context_mgmt/mod.rs`)

### Примечания

- Используется быстрая модель (complete_fast) для экономии времени
- Суммаризация включает 9 обязательных секций (User Intent, Technical Concepts, Files + Code и т.д.)
- Оригинальные сообщения остаются в истории для пользователя, но невидимы для агента
- Summary видима только агенту, невидима пользователю
- Агент не должен упоминать о суммаризации в ответе пользователю

---

## 3. Пайплайн Планирования (Planning Pipeline)

Используется когда нужно создать детальный план выполнения перед началом работы (опциональный режим).

### Схема потока данных

```
┌─────────────────────────────────────────────────────────────────────┐
│  ТРИГГЕР: Запуск с plan_mode=true                                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. ПОСТРОЕНИЕ PLANNER ПРОМПТА                                       │
│  ─────────────────────────────────────────────────────────────────  │
│  • Загрузка: plan.md                                                │
│  • Рендеринг с переменными:                                         │
│    - {{tools}}: Список доступных инструментов с описаниями          │
│                                                                      │
│  ВЫХОД: planner_system_prompt                                       │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. LLM ВЫЗОВ ПЛАНИРОВЩИКА                                          │
│  ─────────────────────────────────────────────────────────────────  │
│  provider.complete(                                                 │
│    &planner_system_prompt,                                          │
│    &user_messages,  // Исходные сообщения пользователя             │
│    &[]              // no tools                                     │
│  )                                                                   │
│                                                                      │
│  ВЫХОД:                                                              │
│  • plan_or_questions (Message): План ИЛИ уточняющие вопросы        │
│  • provider_usage                                                   │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────┴──────────┐
                    │   Вопросы или       │
                    │      План?          │
                    └──────────┬──────────┘
                    ВОПРОСЫ    │    ПЛАН
                    ┌──────────┴──────────┐
                    │                     │
                    ▼                     ▼
┌─────────────────────────────────┐  ┌──────────────────────────────┐
│  3a. ВОПРОСЫ К ПОЛЬЗОВАТЕЛЮ     │  │  3b. ВЫПОЛНЕНИЕ ПЛАНА        │
│  ───────────────────────────     │  │  ──────────────────────      │
│  • Отобразить вопросы            │  │  • План → user message       │
│  • Ждать ответа                  │  │  • Очистить историю          │
│  • Вернуться к шагу 2            │  │  • Запустить executor        │
│    с дополнительным контекстом   │  │    (Main Pipeline)           │
└─────────────────────────────────┘  │  • Plan как первое           │
                                      │    сообщение пользователя    │
                                      └──────────────────────────────┘
```

### Переменные и данные

**Вход:**
- `user_messages` (Vec<Message>): Сообщения пользователя
- `available_tools` (Vec<Tool>): Доступные инструменты

**Между этапами:**
- `planner_system_prompt` (String): Промпт из plan.md
- `plan_or_questions` (Message): Результат от planner AI

**Выход (если план):**
- `plan_message` (Message): Детальный пошаговый план
- Переход к Main Pipeline с планом как user message

**Выход (если вопросы):**
- `questions_message` (Message): Уточняющие вопросы
- Ожидание ответа пользователя → повторный вызов планировщика

### Промпты

- **Шаг 1**: `plan.md` - промпт планировщика

### Ключевые особенности

- **Одноразовый ответ**: Планировщик отвечает только один раз
- **Два режима вывода**:
  - План → появляется как user message в новом контексте для executor
  - Вопросы → появляются как assistant message в текущем контексте
- **Проверка ясности**: Планировщик проверяет достаточно ли информации
- **Зависимости**: План включает указание зависимостей между шагами
- **Условная логика**: План может включать ветвления (if-then-else)

---
